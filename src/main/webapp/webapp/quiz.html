<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>å½±ç‰‡æ¸¬é©—ç³»çµ±</title>
<style>
/* ç¶²é æ•´é«”å­—å‹ã€èƒŒæ™¯è‰² */
body {
	font-family: "Microsoft JhengHei", sans-serif;
	padding: 20px;
	background-color: #f4f4f4;
}

/* é¡Œç›®è¡¨å–®å€å¡Šèˆ‡é–“è· */
#quizForm {
	margin-top: 20px;
}

/* æŒ‰éˆ•æ¨£å¼ï¼ˆé»‘åº•ç™½å­—ï¼‰ */
button {
	background-color: #333;
	color: white;
	padding: 10px 20px;
	border: none;
	border-radius: 6px;
	cursor: pointer;
	margin-right: 10px;
}

/* æ»‘é¼ ç§»å…¥æŒ‰éˆ•è®Šè‰² */
button:hover {
	background-color: #555;
}
</style>
</head>
<body>
	<!-- é é¢æ¨™é¡Œ -->
	<h2>ğŸ¬ æ¸¬é©—ç³»çµ±</h2>

	<!-- å½±ç‰‡é¸æ“‡ä¸‹æ‹‰é¸å–® -->
	<label for="videoSelect">é¸æ“‡å½±ç‰‡ï¼š</label>
	<select id="videoSelect"></select>
	<br>
	<br>

	<!-- YouTube æ’­æ”¾å™¨åµŒå…¥ iframe -->
	<iframe id="videoPlayer" width="560" height="315" frameborder="0"
		allowfullscreen></iframe>
	<br>
	<br>

	<!-- å‡ºé¡Œæ¨¡å¼é¸æ“‡ï¼ˆé è¨­ç‚ºæœ¬åœ°é¡Œåº«ï¼‰ -->
	<label><input type="radio" name="mode" value="local" checked>
		æœ¬åœ°é¡Œåº«</label>
	<label><input type="radio" name="mode" value="gpt"> GPT
		è‡ªå‹•å‡ºé¡Œ</label>
	<br>
	<br>

	<!-- æŒ‰éˆ•ï¼šç”¢ç”Ÿé¡Œç›® -->
	<button id="generateBtn">ç”¢ç”Ÿé¡Œç›®</button>

	<!-- é¡Œç›®å‘ˆç¾å€åŸŸï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰ -->
	<form id="quizForm"></form>

	<!-- æäº¤ä½œç­”æŒ‰éˆ•ï¼ˆé è¨­éš±è—ï¼‰ -->
	<button id="submitBtn" style="display: none">æäº¤ä½œç­”</button>


	<script>
  document.addEventListener("DOMContentLoaded", () => {
    // === DOM å…ƒä»¶å°æ‡‰ ===
    	const userId = localStorage.getItem("userId");
    	if (!userId) {
    		  alert("âš ï¸ å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥ï¼");
    		  window.location.href = "login.html"; // âœ… å¯é¸å°å‘ç™»å…¥é 
    		  return;
    		}


    const videoSelect = document.getElementById("videoSelect");       // ä¸‹æ‹‰é¸å–®
    const videoPlayer = document.getElementById("videoPlayer");       // YouTube æ’­æ”¾å™¨
    const generateBtn = document.getElementById("generateBtn");       // ç”¢ç”Ÿé¡Œç›®æŒ‰éˆ•
    const quizForm = document.getElementById("quizForm");             // é¡Œç›®è¡¨å–®å€å¡Š
    const submitBtn = document.getElementById("submitBtn");           // æäº¤æŒ‰éˆ•
    const modeRadios = document.getElementsByName("mode");            // å‡ºé¡Œæ¨¡å¼

    // é¡Œç›®æ•¸èˆ‡é›£åº¦è¨­å®šï¼ˆé è¨­ï¼‰
    const quizNum = 5;
    const difficulty = "basic";

    // === 1. è¼‰å…¥å½±ç‰‡æ¸…å–® ===
    fetch("/video-learning-platform/api/videoList")
      .then(res => res.json())
      .then(data => {
        videoSelect.innerHTML = ""; // æ¸…ç©ºé¸å–®
        data.forEach((video, index) => {
          const opt = document.createElement("option");
          opt.textContent = `#${index + 1} ${video.title.replace(/^#\d+\s*/, "")}`;
          opt.value = video.videoId;
          videoSelect.appendChild(opt);
        });

        // âœ… è¼‰å…¥ç¬¬ä¸€éƒ¨å½±ç‰‡åˆ°æ’­æ”¾å™¨
        if (data.length > 0) {
          videoPlayer.src = "https://www.youtube.com/embed/" + data[0].videoId;
          videoSelect.value = data[0].videoId;
        }
      });

    // === 2. æ›´æ›å½±ç‰‡æ’­æ”¾ ===
    videoSelect.addEventListener("change", () => {
      videoPlayer.src = "https://www.youtube.com/embed/" + videoSelect.value;
    });

    // === 3. é»æ“Šã€Œç”¢ç”Ÿé¡Œç›®ã€ ===
    generateBtn.addEventListener("click", () => {
      const videoId = videoSelect.value;
      if (!videoId) {
        alert("âš ï¸ è«‹å…ˆé¸æ“‡å½±ç‰‡ï¼");
        return;
      }

      quizForm.innerHTML = "<p>â³ æ­£åœ¨ç”¢ç”Ÿé¡Œç›®...</p>"; // é¡¯ç¤ºè¼‰å…¥ä¸­
      submitBtn.style.display = "none"; // éš±è—æäº¤æŒ‰éˆ•

      // âœ… å–å¾—å‡ºé¡Œæ¨¡å¼
      let mode = "local";
      for (let r of modeRadios) {
        if (r.checked) {
          mode = r.value;
          break;
        }
      }

      // âœ… è¨­å®š API è·¯å¾‘
      const endpoint =
        mode === "local"
          ? `/video-learning-platform/api/loadQuiz?videoId=${videoId}&source=local`
          : `/video-learning-platform/api/autoGenerateQuiz?videoId=${videoId}&quizNum=${quizNum}&difficulty=${difficulty}`;

      // === ç™¼é€è«‹æ±‚ï¼Œè¼‰å…¥é¡Œç›® ===
      fetch(endpoint)
        .then(res => {
          if (!res.ok) throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ (${res.status})`);
          return res.json();
        })
        .then(data => {
          quizForm.innerHTML = ""; // æ¸…ç©ºèˆŠé¡Œç›®
          if (!Array.isArray(data) || data.length === 0) {
            throw new Error("å›å‚³è³‡æ–™ä¸æ˜¯é¡Œç›®é™£åˆ—");
          }

          // âœ… å»ºç«‹æ¯ä¸€é¡Œçš„ HTML çµæ§‹
          data.forEach((q, index) => {
            const div = document.createElement("div");
            div.dataset.quizId = q.quizId || q.id;
            div.dataset.source = mode === "gpt" ? "gpt" : "local";
            div.dataset.correctAnswer = q.answer;

            div.innerHTML = `
              <p><strong>ç¬¬ ${index + 1} é¡Œï¼š${q.question}</strong></p>
              ${q.options.map((opt, i) => `
                <label>
                  <input type="radio" name="q${index}" value="${i}">
                  ${String.fromCharCode(65 + i)}. ${opt}
                </label><br>
              `).join("")}
              <hr>
            `;
            quizForm.appendChild(div);
          });

          submitBtn.style.display = "block"; // é¡¯ç¤ºæäº¤æŒ‰éˆ•
        })
        .catch(err => {
          quizForm.innerHTML = `<p style="color:red;">âŒ é¡Œç›®è¼‰å…¥å¤±æ•—ï¼š${err.message}</p>`;
          submitBtn.style.display = "none";
        });
    });

    // === 4. æäº¤ä½œç­” ===
    submitBtn.addEventListener("click", async () => {
      const totalQuestions = quizForm.querySelectorAll("div").length;

      // âœ… æª¢æŸ¥æ˜¯å¦æ¯é¡Œéƒ½æœ‰é¸æ“‡
      for (let i = 0; i < totalQuestions; i++) {
        const checked = quizForm.querySelector(`input[name="q${i}"]:checked`);
        if (!checked) {
          alert("âš ï¸ è«‹å®Œæˆæ‰€æœ‰é¡Œç›®å†æäº¤ï¼");
          return;
        }
      }

      // âœ… å°è£ä½¿ç”¨è€…ä½œç­”è³‡æ–™
      const answers = [...quizForm.querySelectorAll("div")].map((div, index) => {
        const selectedInput = div.querySelector(`input[name="q${index}"]:checked`);
        const selectedOptionIndex = selectedInput ? parseInt(selectedInput.value) : -1;
        const selectedOptionText = selectedInput?.nextSibling.textContent.trim().replace(/^[A-D]\.\s*/, "");

        return {
          quizId: div.dataset.quizId,
          videoId: videoSelect.value,
          selectedOption: selectedOptionIndex,
          selectedText: selectedOptionText,
          correctAnswer: div.dataset.correctAnswer,
          source: div.dataset.source,
          question: div.querySelector("p")?.textContent.replace(/^ç¬¬ \d+ é¡Œï¼š/, "").trim() || "",
          options: [...div.querySelectorAll("label")].map(label => {
            const text = label.textContent.trim();
            return text.replace(/^[A-D]\.\s*/, "");
          })
        };
      });

      // âœ… ç™¼é€è‡³å¾Œç«¯ API
      try {
        const res = await fetch("/video-learning-platform/api/submitAnswer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
        	userId: parseInt(userId) || -1,
            answers: answers
          })
        });

        if (!res.ok) throw new Error("å¾Œç«¯éŒ¯èª¤");

        const result = await res.json();
        alert(`âœ… æˆåŠŸé€å‡ºä½œç­”ï¼ä½ ç­”å° ${result.correctCount} / ${totalQuestions} é¡Œ`);
        const selectedMode = [...modeRadios].find(r => r.checked)?.value || "local";
        window.location.href = `result.html?videoId=${videoSelect.value}&userId=${userId}&source=${selectedMode}`;



      } catch (err) {
        alert("âŒ ä½œç­”æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
      }
    });
  });
</script>
</body>
</html>

